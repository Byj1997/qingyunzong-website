<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>青云宗管理系统</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "微软雅黑", sans-serif;
        }
        body {
            background-color: #f5f5f5;
            padding: 20px;
        }
        .login-register-box, .main-page, .info-edit-box {
            max-width: 500px;
            margin: 50px auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            display: none;
        }
        .login-register-box.active, .main-page.active, .info-edit-box.active {
            display: block;
        }
        h1, h2, h3 {
            text-align: center;
            color: #333;
            margin-bottom: 20px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            color: #666;
        }
        input, select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        .btn-group {
            display: flex;
            gap: 10px;
        }
        button {
            flex: 1;
            padding: 12px;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
        }
        .login-btn {
            background-color: #4CAF50;
        }
        .login-btn:hover {
            background-color: #45a049;
        }
        .register-btn {
            background-color: #007bff;
        }
        .register-btn:hover {
            background-color: #0069d9;
        }
        .edit-btn {
            background-color: #ffc107;
            color: #333;
            width: 100%;
            margin-top: 10px;
        }
        .edit-btn:hover {
            background-color: #ffca2c;
        }
        .save-btn {
            background-color: #28a745;
            width: 100%;
        }
        .save-btn:hover {
            background-color: #218838;
        }
        .cancel-btn {
            background-color: #dc3545;
            width: 100%;
            margin-top: 10px;
        }
        .cancel-btn:hover {
            background-color: #c82333;
        }
        .menu {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }
        .menu button {
            width: calc(50% - 5px);
            padding: 12px;
        }
        .content {
            display: none;
            padding: 20px;
            border-top: 1px solid #eee;
        }
        .content.active {
            display: block;
        }
        .member-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            margin-bottom: 10px;
            border-radius: 5px;
            background-color: #f9f9f9;
        }
        .member-item button {
            width: 100%;
            margin-top: 5px;
            padding: 8px;
            font-size: 14px;
        }
        .logout-btn {
            background-color: #dc3545;
            width: 100%;
            margin-top: 30px;
        }
        .logout-btn:hover {
            background-color: #c82333;
        }
        .permission-tip {
            color: #dc3545;
            text-align: center;
            margin-top: 20px;
        }
        .edit-tip {
            color: #6c757d;
            text-align: center;
            margin-top: 10px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <!-- 登录/注册合一界面 -->
    <div class="login-register-box active" id="loginRegisterBox">
        <h1>青云宗登录/注册界面</h1>
        <div class="form-group">
            <label for="userName">姓名（账号）</label>
            <input type="text" id="userName" placeholder="请输入姓名/账号">
        </div>
        <div class="form-group">
            <label for="userRole">身份</label>
            <select id="userRole">
                <option value="master">宗主（最高权限）</option>
                <option value="elder">长老</option>
                <option value="disciple">弟子</option>
            </select>
        </div>
        <div class="form-group">
            <label for="userPassword">密码</label>
            <input type="password" id="userPassword" placeholder="注册/登录密码">
        </div>
        <div class="btn-group">
            <button class="login-btn" onclick="login()">登录</button>
            <button class="register-btn" onclick="register()">注册</button>
        </div>
    </div>

    <!-- 个人信息修改界面 -->
    <div class="info-edit-box" id="infoEditBox">
        <h1>个人信息修改</h1>
        <div class="form-group">
            <label for="editNickname">昵称</label>
            <input type="text" id="editNickname" placeholder="请输入昵称">
        </div>
        <div class="form-group">
            <label for="editAge">年龄</label>
            <input type="number" id="editAge" placeholder="请输入年龄">
        </div>
        <div class="form-group">
            <label for="editCultivation">修为境界</label>
            <input type="text" id="editCultivation" placeholder="例如：筑基期/金丹期">
        </div>
        <p class="edit-tip" id="editTip">普通用户仅能修改1次，修改后永久锁定</p>
        <button class="save-btn" onclick="saveUserInfo()">保存信息</button>
        <button class="cancel-btn" onclick="cancelEdit()">取消修改</button>
    </div>

    <!-- 主页面 -->
    <div class="main-page" id="mainPage">
        <h1 id="welcomeTitle">欢迎登录青云宗管理系统</h1>
        <div class="menu" id="menuBar">
            <!-- 菜单根据身份动态生成 -->
        </div>

        <!-- 宗主专属内容 -->
        <div class="content" id="masterContent1">
            <h3>宗主专属 - 宗训门规管理</h3>
            <p>1. 可修改宗训门规，制定宗门规则</p>
            <p>2. 可任免长老，调整宗门架构</p>
            <p>3. 可审批高阶任务，分配宗门资源</p>
        </div>
        <div class="content" id="masterContent2">
            <h3>宗主专属 - 所有成员信息</h3>
            <div id="allMemberList">
                <!-- 所有注册成员列表 -->
            </div>
        </div>

        <!-- 长老专属内容 -->
        <div class="content" id="elderContent1">
            <h3>长老专属 - 宗训门规查看</h3>
            <p>1. 尊师重道，不得以下犯上</p>
            <p>2. 团结同门，不得内斗相残</p>
            <p>3. 坚守本心，不得堕入魔道</p>
            <p>4. 护我宗门，不得泄露机密</p>
        </div>
        <div class="content" id="elderContent2">
            <h3>长老专属 - 个人信息与弟子管理</h3>
            <div id="elderInfo">
                <!-- 长老个人信息 -->
            </div>
            <p style="margin-top: 20px;">当前管理的弟子数量：<span id="discipleCount">0</span></p>
            <p>权限：审核弟子任务、发放宗门贡献</p>
            <button class="edit-btn" id="elderEditBtn" onclick="showEditBox()">修改个人信息</button>
        </div>

        <!-- 弟子专属内容 -->
        <div class="content" id="discipleContent1">
            <h3>弟子专属 - 宗训门规学习</h3>
            <p>1. 每日需背诵宗训门规，完成长老考核</p>
            <p>2. 违反门规将扣除宗门贡献，严重者逐出师门</p>
        </div>
        <div class="content" id="discipleContent2">
            <h3>弟子专属 - 个人信息与任务</h3>
            <div id="discipleInfo">
                <!-- 弟子个人信息 -->
            </div>
            <p>可接任务：</p>
            <p>1. 宗门巡逻 - 奖励：宗门贡献×10</p>
            <p>2. 下山历练 - 奖励：宗门贡献×50</p>
            <button class="edit-btn" id="discipleEditBtn" onclick="showEditBox()">修改个人信息</button>
        </div>

        <!-- 通用无权限提示 -->
        <div class="content" id="noPermissionContent">
            <p class="permission-tip">您暂无访问该内容的权限！</p>
        </div>

        <button class="logout-btn" onclick="logout()">退出登录</button>
    </div>

    <script>
        // 全局变量
        let currentUser = null;
        let editTargetUser = null; // 用于宗主修改他人信息
        // 初始化：检查登录状态
        window.onload = function() {
            checkLoginStatus();
        };

        // 检查登录状态（持久化）
        function checkLoginStatus() {
            const savedUser = localStorage.getItem('qyzz_user_info');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                showMainPage();
            } else {
                showLoginRegister();
            }
        }

        // 注册功能（强制注册：姓名+身份唯一）
        function register() {
            const name = document.getElementById('userName').value.trim();
            const role = document.getElementById('userRole').value;
            const password = document.getElementById('userPassword').value.trim();

            // 空值验证
            if (!name || !password) {
                alert('姓名和密码不能为空！');
                return;
            }

            // 获取已注册用户列表
            let registeredUsers = JSON.parse(localStorage.getItem('qyzz_registered_users')) || [];
            
            // 检查：相同姓名+相同身份的账号是否已存在
            const isExist = registeredUsers.some(user => {
                return user.name === name && user.role === role;
            });

            if (isExist) {
                alert(`【${name}】-${getRoleName(role)} 已注册！请直接登录`);
                return;
            }

            // 新用户默认信息
            const newUser = {
                name: name,
                role: role,
                password: password,
                registerTime: new Date().toLocaleString(),
                score: 0, // 宗门贡献
                nickname: '',
                age: '',
                cultivation: '',
                editCount: 0 // 修改次数：0=未修改，1=已修改（普通用户锁定）
            };
            registeredUsers.push(newUser);
            localStorage.setItem('qyzz_registered_users', JSON.stringify(registeredUsers));

            alert(`注册成功！【${name}】-${getRoleName(role)} 可登录`);
            // 清空输入框
            document.getElementById('userName').value = '';
            document.getElementById('userPassword').value = '';
        }

        // 登录功能（强制注册验证：无注册无法登录）
        function login() {
            const name = document.getElementById('userName').value.trim();
            const role = document.getElementById('userRole').value;
            const password = document.getElementById('userPassword').value.trim();

            // 空值验证
            if (!name || !password) {
                alert('姓名和密码不能为空！');
                return;
            }

            // 获取已注册用户
            const registeredUsers = JSON.parse(localStorage.getItem('qyzz_registered_users')) || [];
            
            // 严格匹配：姓名+身份+密码全部一致
            const matchedUser = registeredUsers.find(user => {
                return user.name === name && user.role === role && user.password === password;
            });

            if (matchedUser) {
                // 登录成功：保存用户信息到本地存储
                currentUser = matchedUser;
                localStorage.setItem('qyzz_user_info', JSON.stringify(currentUser));
                showMainPage();
            } else {
                alert('姓名/身份/密码不匹配，或未注册！请先注册');
            }
        }

        // 显示主页面（根据身份生成专属菜单和内容）
        function showMainPage() {
            // 隐藏登录页，显示主页面
            document.getElementById('loginRegisterBox').classList.remove('active');
            document.getElementById('infoEditBox').classList.remove('active');
            document.getElementById('mainPage').classList.add('active');

            // 设置欢迎标题
            document.getElementById('welcomeTitle').innerText = 
                `欢迎${getRoleName(currentUser.role)}【${currentUser.name}】登录青云宗管理系统`;

            // 生成对应身份的菜单
            generateRoleMenu();

            // 默认显示第一个内容
            showRoleContent(1);
        }

        // 根据身份生成专属菜单
        function generateRoleMenu() {
            const menuBar = document.getElementById('menuBar');
            menuBar.innerHTML = ''; // 清空原有菜单

            if (currentUser.role === 'master') {
                // 宗主菜单
                menuBar.innerHTML = `
                    <button onclick="showRoleContent(1)">宗训门规管理</button>
                    <button onclick="showRoleContent(2)">所有成员信息</button>
                `;
                // 加载所有成员信息
                loadAllMemberList();
            } else if (currentUser.role === 'elder') {
                // 长老菜单
                menuBar.innerHTML = `
                    <button onclick="showRoleContent(1)">宗训门规查看</button>
                    <button onclick="showRoleContent(2)">个人信息与弟子管理</button>
                `;
                // 加载长老个人信息和弟子数量
                loadElderInfo();
                loadDiscipleCount();
                // 检查是否能修改信息
                checkEditPermission('elderEditBtn');
            } else if (currentUser.role === 'disciple') {
                // 弟子菜单
                menuBar.innerHTML = `
                    <button onclick="showRoleContent(1)">宗训门规学习</button>
                    <button onclick="showRoleContent(2)">个人信息与任务</button>
                `;
                // 加载弟子个人信息
                loadDiscipleInfo();
                // 检查是否能修改信息
                checkEditPermission('discipleEditBtn');
            }
        }

        // 显示对应身份的内容（严格权限控制）
        function showRoleContent(index) {
            // 先隐藏所有内容
            hideAllContents();

            // 根据身份和索引显示对应内容
            if (currentUser.role === 'master') {
                if (index === 1) {
                    document.getElementById('masterContent1').classList.add('active');
                } else if (index === 2) {
                    document.getElementById('masterContent2').classList.add('active');
                } else {
                    document.getElementById('noPermissionContent').classList.add('active');
                }
            } else if (currentUser.role === 'elder') {
                if (index === 1) {
                    document.getElementById('elderContent1').classList.add('active');
                } else if (index === 2) {
                    document.getElementById('elderContent2').classList.add('active');
                } else {
                    document.getElementById('noPermissionContent').classList.add('active');
                }
            } else if (currentUser.role === 'disciple') {
                if (index === 1) {
                    document.getElementById('discipleContent1').classList.add('active');
                } else if (index === 2) {
                    document.getElementById('discipleContent2').classList.add('active');
                } else {
                    document.getElementById('noPermissionContent').classList.add('active');
                }
            }
        }

        // 隐藏所有内容
        function hideAllContents() {
            const contents = [
                'masterContent1', 'masterContent2',
                'elderContent1', 'elderContent2',
                'discipleContent1', 'discipleContent2',
                'noPermissionContent'
            ];
            contents.forEach(id => {
                document.getElementById(id).classList.remove('active');
            });
        }

        // 加载所有成员列表（宗主专属：可修改他人信息）
        function loadAllMemberList() {
            const memberList = document.getElementById('allMemberList');
            const registeredUsers = JSON.parse(localStorage.getItem('qyzz_registered_users')) || [];

            if (registeredUsers.length === 0) {
                memberList.innerHTML = '<p class="permission-tip">暂无注册成员</p>';
                return;
            }

            let html = '';
            registeredUsers.forEach((user, index) => {
                html += `
                    <div class="member-item">
                        <p>序号：${index + 1}</p>
                        <p>姓名：${user.name}</p>
                        <p>身份：${getRoleName(user.role)}</p>
                        <p>注册时间：${user.registerTime}</p>
                        <p>昵称：${user.nickname || '未设置'}</p>
                        <p>年龄：${user.age || '未设置'}</p>
                        <p>修为：${user.cultivation || '未设置'}</p>
                        ${user.role === 'disciple' ? `<p>宗门贡献：${user.score}</p>` : ''}
                        <button class="edit-btn" onclick="showEditBox('${user.name}', '${user.role}')">修改该成员信息</button>
                    </div>
                `;
            });
            memberList.innerHTML = html;
        }

        // 加载长老个人信息
        function loadElderInfo() {
            const elderInfo = document.getElementById('elderInfo');
            elderInfo.innerHTML = `
                <p>姓名：${currentUser.name}</p>
                <p>身份：长老</p>
                <p>昵称：${currentUser.nickname || '未设置'}</p>
                <p>年龄：${currentUser.age || '未设置'}</p>
                <p>修为：${currentUser.cultivation || '未设置'}</p>
                <p>注册时间：${currentUser.registerTime}</p>
            `;
        }

        // 统计弟子数量（长老专属）
        function loadDiscipleCount() {
            const registeredUsers = JSON.parse(localStorage.getItem('qyzz_registered_users')) || [];
            const discipleCount = registeredUsers.filter(user => user.role === 'disciple').length;
            document.getElementById('discipleCount').innerText = discipleCount;
        }

        // 加载弟子个人信息
        function loadDiscipleInfo() {
            const discipleInfo = document.getElementById('discipleInfo');
            discipleInfo.innerHTML = `
                <p>姓名：${currentUser.name}</p>
                <p>身份：弟子</p>
                <p>昵称：${currentUser.nickname || '未设置'}</p>
                <p>年龄：${currentUser.age || '未设置'}</p>
                <p>修为：${currentUser.cultivation || '未设置'}</p>
                <p>注册时间：${currentUser.registerTime}</p>
                <p>当前宗门贡献：${currentUser.score}</p>
            `;
        }

        // 检查信息修改权限
        function checkEditPermission(btnId) {
            const btn = document.getElementById(btnId);
            if (currentUser.role === 'master') {
                // 宗主无限修改
                btn.disabled = false;
                btn.innerText = '修改个人信息（无限次）';
            } else {
                if (currentUser.editCount >= 1) {
                    // 普通用户已修改1次，锁定按钮
                    btn.disabled = true;
                    btn.innerText = '信息已锁定（仅可修改1次）';
                } else {
                    // 普通用户未修改，可修改1次
                    btn.disabled = false;
                }
            }
        }

        // 显示信息修改界面
        function showEditBox(targetName, targetRole) {
            // 隐藏其他页面
            document.getElementById('mainPage').classList.remove('active');
            document.getElementById('infoEditBox').classList.add('active');

            // 区分修改自己还是他人（宗主专属）
            if (targetName && targetRole) {
                // 宗主修改他人
                const registeredUsers = JSON.parse(localStorage.getItem('qyzz_registered_users')) || [];
                editTargetUser = registeredUsers.find(u => u.name === targetName && u.role === targetRole);
                document.getElementById('editTip').innerText = `正在修改【${targetName}】-${getRoleName(targetRole)}的信息（宗主权限：无限次）`;
            } else {
                // 修改自己
                editTargetUser = currentUser;
                if (currentUser.role === 'master') {
                    document.getElementById('editTip').innerText = '宗主权限：无限次修改';
                } else {
                    document.getElementById('editTip').innerText = `普通用户仅能修改1次，当前剩余修改次数：${1 - currentUser.editCount}`;
                }
            }

            // 填充已有信息
            document.getElementById('editNickname').value = editTargetUser.nickname || '';
            document.getElementById('editAge').value = editTargetUser.age || '';
            document.getElementById('editCultivation').value = editTargetUser.cultivation || '';
        }

        // 保存个人信息
        function saveUserInfo() {
            const nickname = document.getElementById('editNickname').value.trim();
            const age = document.getElementById('editAge').value.trim();
            const cultivation = document.getElementById('editCultivation').value.trim();

            // 更新用户信息
            editTargetUser.nickname = nickname;
            editTargetUser.age = age;
            editTargetUser.cultivation = cultivation;

            // 普通用户修改次数+1，超过1次锁定
            if (editTargetUser.role !== 'master' && editTargetUser.editCount < 1) {
                editTargetUser.editCount += 1;
            }

            // 同步到用户列表
            let registeredUsers = JSON.parse(localStorage.getItem('qyzz_registered_users')) || [];
            registeredUsers = registeredUsers.map(user => {
                if (user.name === editTargetUser.name && user.role === editTargetUser.role) {
                    return editTargetUser;
                }
                return user;
            });
            localStorage.setItem('qyzz_registered_users', JSON.stringify(registeredUsers));

            // 如果修改的是自己，同步当前登录信息
            if (editTargetUser.name === currentUser.name && editTargetUser.role === currentUser.role) {
                currentUser = editTargetUser;
                localStorage.setItem('qyzz_user_info', JSON.stringify(currentUser));
            }

            alert('信息保存成功！');
            // 返回主页面
            showMainPage();
        }

        // 取消修改
        function cancelEdit() {
            document.getElementById('infoEditBox').classList.remove('active');
            document.getElementById('mainPage').classList.add('active');
        }

        // 退出登录
        function logout() {
            // 清除登录状态
            localStorage.removeItem('qyzz_user_info');
            currentUser = null;
            editTargetUser = null;
            // 返回登录注册页
            showLoginRegister();
            alert('已安全退出登录！');
        }

        // 显示登录注册页
        function showLoginRegister() {
            document.getElementById('loginRegisterBox').classList.add('active');
            document.getElementById('infoEditBox').classList.remove('active');
            document.getElementById('mainPage').classList.remove('active');
            // 清空输入框
            document.getElementById('userName').value = '';
            document.getElementById('userPassword').value = '';
        }

        // 辅助函数：转换身份名称
        function getRoleName(role) {
            const roleMap = {
                master: '宗主',
                elder: '长老',
                disciple: '弟子'
            };
            return roleMap[role] || '未知身份';
        }
    </script>
</body>
</html>